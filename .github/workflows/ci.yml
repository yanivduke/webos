name: CI/CD Pipeline

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  server-tests:
    name: Server Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: src/server/package-lock.json

    - name: Install server dependencies
      working-directory: ./src/server
      run: npm ci

    - name: Run server tests
      working-directory: ./src/server
      run: npm test

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: matrix.node-version == '20.x'
      with:
        file: ./src/server/coverage/lcov.info
        flags: server
        fail_ci_if_error: false

  client-build:
    name: Client Build & Type Check
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: src/client/package-lock.json

    - name: Install client dependencies
      working-directory: ./src/client
      run: npm ci

    - name: Run type check
      working-directory: ./src/client
      run: npm run type-check

    - name: Build client
      working-directory: ./src/client
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: matrix.node-version == '20.x'
      with:
        name: client-dist
        path: src/client/dist
        retention-days: 7

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Audit server dependencies
      working-directory: ./src/server
      run: |
        npm ci
        npm audit --audit-level=moderate || true

    - name: Audit client dependencies
      working-directory: ./src/client
      run: |
        npm ci
        npm audit --audit-level=moderate || true

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Check for duplicate dependencies
      run: |
        echo "Checking for duplicate dependencies in package.json files..."
        if grep -o '"[^"]*"' src/server/package.json | sort | uniq -d | grep -v "^\"$" ; then
          echo "::error::Found duplicate dependencies in src/server/package.json"
          exit 1
        fi
        if grep -o '"[^"]*"' src/client/package.json | sort | uniq -d | grep -v "^\"$" ; then
          echo "::error::Found duplicate dependencies in src/client/package.json"
          exit 1
        fi
        echo "✓ No duplicate dependencies found"

    - name: Check for syntax errors
      run: |
        find . -name "*.js" -not -path "*/node_modules/*" -not -path "*/dist/*" -exec node --check {} \;
        echo "✓ No syntax errors found"

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [server-tests, client-build]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Install all dependencies
      run: |
        cd src/server && npm ci
        cd ../client && npm ci

    - name: Start server
      working-directory: ./src/server
      run: |
        npm start &
        sleep 5
        curl -f http://localhost:3001/api/health || exit 1

    - name: Test API endpoints
      run: |
        curl -f http://localhost:3001/api/system/status
        curl -f http://localhost:3001/api/settings
        curl -f http://localhost:3001/api/files/list?path=df0
        echo "✓ All API endpoints responding"
