name: Safe Merge Strategy

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - master
      - develop

  # Manual trigger for emergency merges
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to merge from'
        required: true
      target_branch:
        description: 'Target branch to merge to'
        required: true
        default: 'main'
      merge_strategy:
        description: 'Merge strategy'
        required: true
        type: choice
        options:
          - merge
          - squash
          - rebase

jobs:
  pre-merge-validation:
    name: Pre-Merge Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.event.inputs.source_branch }}

      - name: Fetch all branches
        run: |
          git fetch origin --all
          git branch -a

      - name: Verify no uncommitted changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "âŒ Uncommitted changes detected!"
            git status
            exit 1
          fi
          echo "âœ… Working tree is clean"

      - name: Check branch is up to date
        if: github.event_name == 'pull_request'
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"
          git fetch origin "$TARGET_BRANCH"

          BEHIND_COUNT=$(git rev-list --count HEAD..origin/$TARGET_BRANCH)

          if [ "$BEHIND_COUNT" -gt 0 ]; then
            echo "âš ï¸ Branch is $BEHIND_COUNT commits behind $TARGET_BRANCH"
            echo "Consider rebasing before merge"
          else
            echo "âœ… Branch is up to date"
          fi

      - name: Create backup reference
        run: |
          BACKUP_REF="refs/backup/$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
          git update-ref "$BACKUP_REF" HEAD
          echo "ðŸ“¦ Backup created: $BACKUP_REF"
          echo "backup_ref=$BACKUP_REF" >> $GITHUB_OUTPUT
        id: backup

  code-preservation-check:
    name: Code Preservation Check
    runs-on: ubuntu-latest
    needs: pre-merge-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze changes
        if: github.event_name == 'pull_request'
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"
          git fetch origin "$TARGET_BRANCH"

          echo "## ðŸ“Š Change Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Files changed
          FILES_CHANGED=$(git diff --name-only "origin/$TARGET_BRANCH"...HEAD | wc -l)
          echo "- **Files Changed:** $FILES_CHANGED" >> $GITHUB_STEP_SUMMARY

          # Lines added/removed
          STATS=$(git diff --shortstat "origin/$TARGET_BRANCH"...HEAD)
          echo "- **Changes:** $STATS" >> $GITHUB_STEP_SUMMARY

          # Check for large deletions
          DELETIONS=$(git diff --numstat "origin/$TARGET_BRANCH"...HEAD | awk '{sum+=$2} END {print sum}')
          if [ "$DELETIONS" -gt 500 ]; then
            echo "- âš ï¸ **Warning:** Large number of deletions detected ($DELETIONS lines)" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Large deletions detected. Please review carefully to avoid code loss."
          fi

          # List deleted files
          DELETED_FILES=$(git diff --diff-filter=D --name-only "origin/$TARGET_BRANCH"...HEAD)
          if [ -n "$DELETED_FILES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ—‘ï¸ Deleted Files" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$DELETED_FILES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Detect potential code loss
        if: github.event_name == 'pull_request'
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"

          # Check for files that exist in target but not in source
          git checkout "origin/$TARGET_BRANCH"
          TARGET_FILES=$(git ls-files | sort)

          git checkout "${{ github.event.pull_request.head.sha }}"
          SOURCE_FILES=$(git ls-files | sort)

          MISSING_FILES=$(comm -23 <(echo "$TARGET_FILES") <(echo "$SOURCE_FILES"))

          if [ -n "$MISSING_FILES" ]; then
            echo "âš ï¸ Files in target but not in source (potential loss):"
            echo "$MISSING_FILES"
            echo "::warning::Files present in target branch but missing in source. Review before merge."
          fi

  merge-simulation:
    name: Merge Simulation
    runs-on: ubuntu-latest
    needs: [pre-merge-validation, code-preservation-check]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Simulate merge
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "Merge Simulator"
          git config user.email "ci@webos.local"

          TARGET_BRANCH="${{ github.base_ref }}"
          git fetch origin "$TARGET_BRANCH"
          git checkout "origin/$TARGET_BRANCH"

          echo "## ðŸ”„ Merge Simulation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Try merge
          if git merge --no-commit --no-ff "${{ github.event.pull_request.head.sha }}"; then
            echo "âœ… Merge simulation successful" >> $GITHUB_STEP_SUMMARY

            # Show what would be committed
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Files to be merged:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git diff --name-status HEAD >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            git merge --abort
          else
            echo "âŒ Merge conflicts detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Conflicting files:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git diff --name-only --diff-filter=U >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            git merge --abort
            exit 1
          fi

  integration-test:
    name: Integration Test After Merge
    runs-on: ubuntu-latest
    needs: merge-simulation

    steps:
      - name: Checkout merged state
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Simulate merged state
        if: github.event_name == 'pull_request'
        run: |
          git config user.name "Test Merger"
          git config user.email "test@webos.local"

          TARGET_BRANCH="${{ github.base_ref }}"
          git fetch origin "$TARGET_BRANCH"
          git checkout "origin/$TARGET_BRANCH"
          git merge --no-commit --no-ff "${{ github.event.pull_request.head.sha }}"

      - name: Test client in merged state
        working-directory: ./src/client
        run: |
          npm ci
          npm run type-check
          npm run build

      - name: Test server in merged state
        working-directory: ./src/server
        run: |
          npm ci
          npm run build || true

      - name: Cleanup
        if: always()
        run: git merge --abort || true

  merge-approval-summary:
    name: Merge Approval Summary
    runs-on: ubuntu-latest
    needs: [pre-merge-validation, code-preservation-check, merge-simulation, integration-test]
    if: always()

    steps:
      - name: Generate merge approval report
        run: |
          echo "## âœ… Merge Safety Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All safety checks completed. Review results before merging:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Merge Validation | ${{ needs.pre-merge-validation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Preservation | ${{ needs.code-preservation-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge Simulation | ${{ needs.merge-simulation.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Test | ${{ needs.integration-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.pre-merge-validation.result }}" == "success" && \
                "${{ needs.code-preservation-check.result }}" == "success" && \
                "${{ needs.merge-simulation.result }}" == "success" && \
                "${{ needs.integration-test.result }}" == "success" ]]; then
            echo "### âœ… SAFE TO MERGE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed. This PR can be safely merged." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âš ï¸ REVIEW REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some checks failed. Please review before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
